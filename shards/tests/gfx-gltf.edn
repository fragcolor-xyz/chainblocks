(def timestep (/ 1.0 120.0))
(defmesh root)

(defpure get-view-transform
  (| (Float4 0 0.2 0.2 1.0) >= .arm-pos)
  (Math.AxisAngleY) (Math.Rotation) (Math.MatMul .arm-pos) (ToFloat3) >= .arm-pos-3
  {:Position .arm-pos-3 :Target (Float3 0 0.025 0)} (Math.LookAt))

(defshards get-xy-wave-transform [x time]
  time (Math.Multiply 4.5) (Math.Cos) (Math.Multiply 0.01) >= .tmp-y
  [x .tmp-y 0] (ToFloat3) (Math.Translation))

(defshards default-setup []
  0.0 >= .time

  ;; Render steps
  (GFX.BuiltinFeature :Id BuiltinFeatureId.Transform) >> .features
  (GFX.BuiltinFeature :Id BuiltinFeatureId.BaseColor) >> .features
  (GFX.DrawQueue) >= .queue
  {:Features .features :Queue .queue} (GFX.DrawablePass) >> .render-steps

  ;; Create view
  0.0 (Do get-view-transform) >= .view-transform
  (GFX.View :View .view-transform) >= .view)

(defshards default-window []
  (GFX.MainWindow
   :Title "SDL Window" :Width 1280 :Height 720 :Debug false
   :Contents
   (->
    ;; Rotate camera
    .time (Math.Add timestep) > .time
    .time (Do get-view-transform) > .view-transform

    .drawables (GFX.Draw .queue)
    (GFX.Render :Steps .render-steps :View .view))))

(defloop test-path-static
  (Setup
   (default-setup)
   (Float3 0.02) (Math.Scaling)
   (GFX.glTF :Path "data/building.glb") >> .drawables)

  (default-window))
(schedule root test-path-static)
(if (run root timestep 100) nil (throw "Root tick failed"))

(defloop test-path-var
  (Setup
   (default-setup)
   "../../external/glTF-Sample-Models/2.0/Avocado/glTF-Binary/Avocado.glb" >= .path-var
   (Math.MatIdentity) (GFX.glTF :Path .path-var) >> .drawables)

  (default-window))
(schedule root test-path-var)
(if (run root timestep 100) nil (throw "Root tick failed"))

(defloop test-binary
  (Setup
   (default-setup)
   "../../external/glTF-Sample-Models/2.0/Avocado/glTF-Binary/Avocado.glb" (FS.Read :Bytes true) >= .bytes
   (Math.MatIdentity) (GFX.glTF :Bytes .bytes) >> .drawables)

  (default-window))
(schedule root test-binary)
(if (run root timestep 100) nil (throw "Root tick failed"))

(defloop test-transforms
  (Setup
   (default-setup)
   (Float3 -0.05 0 0) (Math.Translation) >= .t1
   (get-xy-wave-transform 0.0 0.0) >= .t2
   (Float3 0.05 0 0) (Math.Translation) >= .t3)

  (GFX.MainWindow
   :Title "SDL Window" :Width 1280 :Height 720 :Debug false
   :Contents
   (->
    ;; Rotate camera
    .time (Math.Add timestep) > .time
    .time (Do get-view-transform) > .view-transform
    (get-xy-wave-transform 0.0 .time) > .t2

    .t1 (GFX.glTF :Path "../../external/glTF-Sample-Models/2.0/Avocado/glTF-Binary/Avocado.glb") >> .drawables
    .t2 (GFX.glTF :Path "../../external/glTF-Sample-Models/2.0/Avocado/glTF-Binary/Avocado.glb") >> .drawables
    .t3 (GFX.glTF :Path "../../external/glTF-Sample-Models/2.0/Avocado/glTF-Binary/Avocado.glb") >> .drawables
    .drawables (GFX.Draw .queue)
    (GFX.Render :Steps .render-steps :View .view))))
(schedule root test-transforms)
(if (run root timestep 100) nil (throw "Root tick failed"))

(defloop test-copy
  (Setup
   (default-setup)
   (Float3 -0.05 0 0) (Math.Translation) >= .t1
   (Float3 0.05 0 0) (Math.Translation) >= .t2
   .t1 (GFX.glTF :Path "../../external/glTF-Sample-Models/2.0/Avocado/glTF-Binary/Avocado.glb") >= .avocado-a
   .avocado-a >> .drawables
   .t2 (GFX.glTF :Copy .avocado-a) >> .drawables)

  (default-window))
(schedule root test-copy)
(if (run root timestep 100) nil (throw "Root tick failed"))
