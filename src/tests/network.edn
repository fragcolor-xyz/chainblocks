; SPDX-License-Identifier: BSD-3-Clause
; Copyright Â© 2019 Fragcolor Pte. Ltd.

(def network-test-server
  (Wire "server" :Looped
         (Network.Server
          "127.0.0.1" 9191
          (-> ; this acts like a callback                                        
           (Ref "pkt") ; the input of this flow will be the received packet
           ;; (Get remote)  ; Context variable Network.RemoteEndpoint will be the current remote
           ;; (Cond
           ;;  [(->
           ;;    (Is "127.0.0.1"))
           ;;   (->
           ;;    (Msg "Hey localhost!"))
           ;;   (-> true)
           ;;   (->
           ;;    (Msg "Hey remote host!"))
           ;;   ])
           (Get "pkt")
           (Log)
                                        ; send something to the client
                                        ; will use automatically the context vars
           "Ok"
           (Network.Send)
           ))))

(def client-init
  (Wire "init"
         "Hey server"
         (Network.Send)
         2019
         (Network.Send)
         99.9
         (Network.Send)
         (Float4 3 2 1 0)
         (Network.Send)
         (Const [1 2 3 4 5])
         (Network.Send)
         ))

(def network-test-client
  (Wire "client" :Looped
         (Network.Client
          "127.0.0.1" 9191
          (-> ; acting as callback when there is a new pkt
           (Log)
           ))
                                        ; test some sending
                                        ; will send to the client in context
                                        ; which is the above
                                        ; Network.RemoteEndpoint
                                        ; are the injected variables
         (Once (Do client-init))
         ))

(defmesh main)
(schedule main network-test-server)
(schedule main network-test-client)
(run main 0.01 100)
(def network-test-server nil)
(def network-test-client nil)
(def main nil)          
