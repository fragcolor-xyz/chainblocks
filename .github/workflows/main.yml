name: CI

on: [push, pull_request]

jobs:
  ciLinuxDbg:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: Build
      run: |
        git submodule update --init --recursive
        docker build -f docker/linux/Dockerfile -t chainblocks-test --build-arg USER_ID=`id -u` --build-arg GROUP_ID=`id -g` --build-arg JOB_ID=$CI_JOB_ID .
    - name: Test
      run: |
        docker run --rm -t --cap-add=SYS_PTRACE -u`id -u`:`id -g` chainblocks-test bash -c "mkdir build && cd build && cmake -G Ninja -DCMAKE_BUILD_TYPE=Debug .. && ninja cbl && ./cbl ../src/tests/general.clj && ./cbl ../src/tests/variables.clj && ./cbl ../src/tests/linalg.clj && ./cbl ../src/tests/channels.clj"

  ciLinuxRel:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: Build
      run: |
        git submodule update --init --recursive
        docker build -f docker/linux/Dockerfile -t chainblocks-test --build-arg USER_ID=`id -u` --build-arg GROUP_ID=`id -g` --build-arg JOB_ID=$CI_JOB_ID .
    - name: Test
      run: |
        docker run --rm -t --cap-add=SYS_PTRACE -u`id -u`:`id -g` chainblocks-test bash -c "mkdir build && cd build && cmake -G Ninja -DCMAKE_BUILD_TYPE=Release .. && ninja cbl && ./cbl ../src/tests/general.clj && ./cbl ../src/tests/variables.clj && ./cbl ../src/tests/linalg.clj && ./cbl ../src/tests/channels.clj"

  ciLinuxValgrind:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: Build
      run: |
        git submodule update --init --recursive
        docker build -f docker/linux/Dockerfile -t chainblocks-test --build-arg USER_ID=`id -u` --build-arg GROUP_ID=`id -g` --build-arg JOB_ID=$CI_JOB_ID .
    - name: Test
      run: |
        docker run --rm -t --cap-add=SYS_PTRACE -u`id -u`:`id -g` chainblocks-test bash -c "mkdir build && cd build && cmake -G Ninja -DCB_NO_BIGINT_BLOCKS=1 -DUSE_VALGRIND=1 -DBUILD_CORE_ONLY=1 -DCMAKE_BUILD_TYPE=RelWithDebInfo .. && ninja cbl && valgrind --exit-on-first-error=yes --error-exitcode=1 ./cbl ../src/tests/general.clj && valgrind --exit-on-first-error=yes --error-exitcode=1 ./cbl ../src/tests/variables.clj && valgrind --exit-on-first-error=yes --error-exitcode=1 ./cbl ../src/tests/flows.clj && valgrind --exit-on-first-error=yes --error-exitcode=1 ./cbl ../src/tests/linalg.clj && valgrind --exit-on-first-error=yes --error-exitcode=1 ./cbl ../src/tests/channels.clj && valgrind --exit-on-first-error=yes --error-exitcode=1 ./cbl ../src/tests/genetic.clj && valgrind --exit-on-first-error=yes --error-exitcode=1 ./cbl ../src/tests/lmdb.clj && valgrind --exit-on-first-error=yes --error-exitcode=1 ./cbl ../src/tests/http.clj"

  ciWindowsRel:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v1
    - run: |
        git submodule update --init --recursive
    - uses: msys2/setup-msys2@v1
      with:
        msystem: MINGW64
        release: true
    - run: msys2 ./build-win.sh Release
    - uses: actions/upload-artifact@master
      with:
        name: cbl-win64
        path: build/cbl.exe

  ciWindowsRel32:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v1
    - run: |
        git submodule update --init --recursive
    - uses: msys2/setup-msys2@v1
      with:
        msystem: MINGW32
        release: true
    - run: msys2 ./build-win32.sh Release
    - uses: actions/upload-artifact@master
      with:
        name: cbl-win32
        path: build/cbl.exe

  ciWindowsDbg:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v1
    - run: |
        git submodule update --init --recursive
    - uses: msys2/setup-msys2@v1
      with:
        msystem: MINGW64
        release: true
    - run: msys2 ./build-win.sh Debug

  ciWindowsDbg32:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v1
    - run: |
        git submodule update --init --recursive
    - uses: msys2/setup-msys2@v1
      with:
        msystem: MINGW32
        release: true
    - run: msys2 ./build-win32.sh Debug

  ciMacDbg:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v1
    - name: Deps
      run: |
        sudo xcode-select --switch /Applications/Xcode_11.app
        brew install boost cmake ninja clang-format
    - name: Build
      run: |
        git submodule update --init --recursive
        mkdir build
        cd build
        cmake -G Ninja -DFORCE_CORE2=1 -DCMAKE_BUILD_TYPE=Debug ..
        ninja cbl
    - name: Test
      run: |
        cd build
        ./cbl ../src/tests/general.clj
        ./cbl ../src/tests/variables.clj
        ./cbl ../src/tests/subchains.clj
        ./cbl ../src/tests/linalg.clj
        ./cbl ../src/tests/loader.clj
        ./cbl ../src/tests/network.clj
        ./cbl ../src/tests/struct.clj
        ./cbl ../src/tests/flows.clj
        ./cbl ../src/tests/kdtree.clj
        ./cbl ../src/tests/channels.clj
        ./cbl ../src/tests/lmdb.clj
        ./cbl ../src/tests/genetic.clj
        ./cbl ../src/tests/imaging.clj
        ./cbl ../src/tests/http.clj
        ./cbl ../src/tests/snappy.clj
        ./cbl ../src/tests/ws.clj
        ./cbl ../src/tests/bigint.clj

  ciMacRel:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v1
    - name: Deps
      run: |
        sudo xcode-select --switch /Applications/Xcode_11.app
        brew install boost cmake ninja clang-format
    - name: Build
      run: |
        git submodule update --init --recursive
        mkdir build
        cd build
        cmake -G Ninja -DFORCE_CORE2=1 -DCMAKE_BUILD_TYPE=Release ..
        ninja cbl
    - name: Test
      run: |
        cd build
        ./cbl ../src/tests/general.clj
        ./cbl ../src/tests/variables.clj
        ./cbl ../src/tests/subchains.clj
        ./cbl ../src/tests/linalg.clj
        ./cbl ../src/tests/loader.clj
        ./cbl ../src/tests/network.clj
        ./cbl ../src/tests/struct.clj
        ./cbl ../src/tests/flows.clj
        ./cbl ../src/tests/kdtree.clj
        ./cbl ../src/tests/channels.clj
        ./cbl ../src/tests/lmdb.clj
        ./cbl ../src/tests/genetic.clj
        ./cbl ../src/tests/imaging.clj
        ./cbl ../src/tests/http.clj
        ./cbl ../src/tests/snappy.clj
        ./cbl ../src/tests/ws.clj
        ./cbl ../src/tests/bigint.clj
  
  rustBuild:
    name: Rust check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Fetch chainblocks core
        run: |
          git submodule update --init --recursive
      - name: Build tester image
        run: |
          docker build -f rust/docker/Dockerfile -t chainblocks-test --build-arg USER_ID=`id -u` --build-arg GROUP_ID=`id -g` --build-arg JOB_ID=$CI_JOB_ID .
      - name: Test
        run: |
          docker run --rm -t --cap-add=SYS_PTRACE -u`id -u`:`id -g` chainblocks-test bash -c "sh rust/docker/run_linux.sh"
